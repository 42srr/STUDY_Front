[모던 자바스크립트 Deep Dive]
[24장] 클로저

---

### 1. 렉시컬 스코프

- 렉시컬 스코프에 의한 렉시컬 환경

	- 중첩 함수 innerFunc 내부에서 자신을 포함하고 있는 외부 함수 outerFunc의 변수에 접근 가능함

- 렉시컬 스코프(정적 스코프)

	- 자바스크립트 엔진은 함수를 어디서 호출했는지가 아니라 함수를 어디에 정의했는지에 따라 상위 스코프를 결정함

	- 렉시컬 환경의 외부 렉시컬 환경에 대한 참조에 저장할 참조값, 즉 상위 스코프에 대한 참조는 함수 정의가 평가되는 시점에 함수가 정의된 환경(위치)에 의해 결정됨

---

### 2. 함수 객체의 내부 슬롯 [[Environment]]

- 함수 정의 위치에 따라 상위 스코프를 결정하는 렉시컬 스코프

	- 렉시컬 스코프가 가능하려면 함수는 자신이 정의된 상위 스코프를 기억해야 함

	- 함수는 자신의 내부 슬롯 [[Environment]]에 
	현재 실행 중인 실행 컨텍스트의 렉시컬 환경의 참조를 저장함
	
		- 자신이 정의된 상위 스코프의 참조임
	
		- 자신이 호출되었을 때 생성될 함수 렉시컬 환경의 외부 렉시컬 환경에 대한 참조에 저장될 참조값임

	- 함수 렉시컬 환경의 구성 요소인 외부 렉시컬 환경에 대한 참조에는 함수 객체의 내부 슬롯 [[Environment]]에 저장된 렉시컬 환경의 참조가 할당됨

---

### 3. 클로저와 렉시컬 환경

- 클로저

	- 외부 함수보다 중첩 함수가 더 오래 유지되는 경우 이미 생명 주기가 종료한 외부 함수의 변수를 참조 가능한 중첩 함수
	
	- 일반적으로는 중첩 함수가 상위 스코프의 식별자를 참조하고 있고 중첩 함수가 외부 함수보다 더 오래 유지되는 경우로 한정함
	
	- 이론적으로는 자바스크립트의 모든 함수가 상위 스코프를 기억하므로 클로저라고 할 수도 있음 (각자의 소멸 시기에 의해 본질에 부합하지 않긴 함)
	
	- 상위 스코프의 식별자 중에서 클로저가 참조하고 있는 식별자만을 기억함
	
- 자유 변수

	- 클로저에 의해 참조되는 변수

- 클로저에 대한 MDN 정의

	- outer 하수의 실행 컨텍스트는 실행 컨텍스트 스택에서 제거되지만 outer 함수의 렉시컬 환경까지 소멸하는 것은 아님
	
	- outer 함수의 렉시컬 환경은 inner 함수의 [[Environment]] 내부 슬롯에 의해 참조되고 있고, inner 함수는 전역 변수 innerFunc에 의해 참조되고 있으므로 가비지 컬렉션의 대상이 아님

---

### 4. 클로저의 활용

- 클로저의 활용

	- 클로저는 상태를 안전하게 은닉, 특정 함수에게만 상태 변경을 허용함
	
		- const increase = (function () { let num = 0; return function () { return ++num; }; }()); -> O
	
		- const increase = function () { let num = 0; return ++num; }; -> X
	
	- 보조 함수를 매개변수로 쓰면 반환 시에는 자신만의 독립된 렉시컬 환경을 생성하여 가지게 됨
	
		- 카운트를 유지하기 위한 자유 변수를 공유하지 않아 카운터의 증감이 연동되지 않음
		
		- 카운터의 증감을 연동하려면 렉시컬 환경을 공유하는 클로저를 생성해야 함 (객체 1개만 생성)

---

### 5. 캡슐화와 정보 은닉

- 캡슐화

	- 객체의 상태를 나타내는 프로퍼티와 프로퍼티를 참조하고 조작 가능한 동작인 메서드를 하나로 묶는 것 + 정보 은닉
	
- 정보 은닉

	- 객체의 특정 프로퍼티나 메서드를 감추는 것
	
	- 객체 상태 변경 방지, 객체 간의 결합도를 낮춤

---

### 6. 자주 발생하는 실수

- for (var i=0; i<3; i++) funcs[i] = function () { return i; }; funcs[0](); 하면 for 문의 var 변수 i를 참조해 i가 3이 됨

	- 자바스크립트의 함수 레벨 스코프 특성으로 인해 for 문의 변수 선언문에서 var 변수가 전역 변수가 되기 때문에 발생함 (독립적인 렉시컬 환경 생성)

	- let 키워드를 사용 시 해결됨

---
